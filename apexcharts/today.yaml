type: custom:apexcharts-card
hours_12: false
header:
  title: Prices today
  show: true
  show_states: true
now:
  show: true
  color: "#ffffff"
  label: Now
graph_span: 1d
span:
  start: day
series:
  - entity: sensor.power_price
    name: " "
    type: column
    extend_to: end
    show:
      legend_value: false
      in_header: false
    data_generator: |
      const COLORS={
        lowest:'#007f3b',
        next5low:'#33a36b',
        brightGreen:'#00e676',
        highest:'#c62828',
        next5high:'#ef5350',
        yellow:'#ffff00',
        amber:'#ff9000'
      };

      const LEVEL_COLORS={
        'Cheap':COLORS.lowest,
        'Cheap time':COLORS.brightGreen,
        'Cheapest hour':COLORS.lowest,
        'Cheapest hours':COLORS.next5low,
        'Normal':COLORS.yellow,
        'Expensive':COLORS.amber,
        'Most expensive hours':COLORS.next5high,
        'Most expensive hour':COLORS.highest
      };

      const raw=(entity && entity.attributes && entity.attributes.raw_today)
        ? entity.attributes.raw_today
        : [];

      const byHour={};
      for(let i=0;i<raw.length;i++){
        const e=raw[i];
        if(!e || !e.start) continue;

        const d=new Date(e.start);
        d.setMinutes(0,0,0);

        const k=d.getTime();
        if(!byHour[k]) byHour[k]=[];

        byHour[k].push(Number(e.value));
      }

      const MID=30*60*1000;

      const keys=Object.keys(byHour).sort();
      let data=[];

      for(let j=0;j<keys.length;j++){
        const kNum=Number(keys[j]);
        const vals=byHour[keys[j]];

        let s=0;
        for(let v=0;v<vals.length;v++) s+=Number(vals[v]);

        const avg=vals.length ? (s/vals.length) : 0;
        const h=new Date(kNum).getHours();

        data.push({
          x:new Date(kNum + MID),
          y:avg,
          h
        });
      }

      if(!data.length) return [];

      const lvlEnt=(typeof hass!=='undefined' && hass.states)
        ? hass.states['sensor.power_price_level']
        : null;

      const levels=(
        lvlEnt &&
        lvlEnt.attributes &&
        lvlEnt.attributes.en_prices &&
        Array.isArray(lvlEnt.attributes.prices.today)
      ) ? lvlEnt.attributes.en_prices.today : [];

      const out=[];
      for(let q=0;q<data.length;q++){
        const pt=data[q];
        const idx=pt.h;

        const label=(
          levels[idx] !== undefined &&
          levels[idx] !== null
        ) ? String(levels[idx]).trim() : '';

        const color=LEVEL_COLORS[label] || COLORS.yellow;

        out.push({
          x:pt.x,
          y:pt.y,
          fillColor:color
        });
      }

      return out;
